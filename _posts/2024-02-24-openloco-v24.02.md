---
title:      "OpenLoco version 24.02"
tagline:    "The greatest implementation progress month!"
author:     "Duncan Frost"
date:       2024-02-24 09:30:00 +0000
layout:     single
classes:    wide
categories: news
---

OpenLoco v24.02 is out! This month represents a huge step forward in our percentage of
reimplementation. There isn't much in terms of features but there have been a healthy douse of
bug fixes in this release.

We hope you'll enjoy reading this dev log, and will take the new release for a spin as well.

As always, please find the
[changelog](https://github.com/OpenLoco/OpenLoco/blob/v24.02/CHANGELOG.md)
on GitHub.

## Implement Train Station Placement Game Command (#2202)

Implementing all of the game commands is a long running project that the team has. We have been
ignoring all of the station (train, road, airport, dock) functions so far as they are quite
complex but with the winter break we finally decided to bash one of them out. Implementing the
function showed there was a number of little issues in vanilla Locomotion related to train
stations. In vanilla when an ai preallocates a station it is allowed to do this without first
placing a track piece. We aren't exactly sure why this allowed but to allow this there is
multiple special case bits of code. Within one of those special cases the function gets confused
trying to work out if there is vertical space for the station. The bug will cause the ai to then
assume that a station could be placed where it can't. Ultimately no invalid station gets created
but it does change where the ai places its stations. Lets hope the other stations (road, airport
and dock) don't have similar issues.

## Implement Last Journey Average Speed (#2173)

I (@duncanspumpkin) implemented this a few months ago but there was some odd code in the
implementation that did not sit right. After leaving it on the shelf for a few months I realised
that the odd bit of code was all to avoid doing a 64-bit division. Locomotion was created in
assembly and uses only 32-bit x86 instructions and unfortunately there is no 64-bit division so
Chris Sawyer had to implement the divide as multiple instructions. This is all pretty standard but
if you aren't expecting it the code looks a little unorthodox. Fortunately as we write in C++ we
don't need to worry about this and the compiler will happily create an equivalent.

## Implement Paint Wall (#2222)

Locomotions rendering uses the [painters algorithm](https://en.wikipedia.org/wiki/Painter%27s_algorithm)
to achieve this it converts every map element (building, surface, track, etc.) and map entity
(vehicle, money effect, smoke, etc.) into an image and a 3d bounding box. It will then sort the
3d bounding boxes and draw the images from back to front. We call the translation of a map item
into its bounding box and image a 'paint' function. @ZehMatt decided that the time was ripe to
implement the wall paint function. It exposed a lot of features of walls that are not currently
being exploited by custom object creators. Did you know walls can have: transparent (glass)
elements; or that they can have two sided images? Well now you do and we have documented exactly
what flags need to be set to enable this.

## Implement Paint Track and Track Additions (#2259, #2263, #2276)

The track paint functions represent a massive ~5% of the vanilla game. They are very repetitive
and were likely implemented using some sort of automated generation code. When we worked on
OpenRCT2 (which uses the same engine as OpenLoco) @marijnvdwerf realised that we needed a way to
verify that our implementation of each paint function matched the output of vanilla. So to do this
he installed some scaffolding code around the paint function. This was called TestPaint. After a
few days of writing this though @marijnvdwerf realised we could also just make the verification
function output out a new C++ version of the original function. On OpenRCT2 this meant we suddenly
went from ~80% completion to 99.999% completion in one day! We always planned to do something
similar for OpenLoco but the code worked a bit differently so no one had attempted it, until now!
The exact same technique was used but the generated code was structured very differently. One of
the big issues on OpenRCT2 is how challenging it is to add new track pieces. One of the reasons
it is difficult is because the paint functions are hard to write correctly. For OpenLoco we don't
want to repeat this and now instead of ~400 functions we have 2 short 10 line functions that achieve
exactly the same output! To add a new track pieces drawing function its a simple matter of adding
the images and their bounding boxes to a table and the rest is taken care of. As we measure
percentage completion by how many vanilla functions we have implemented this is a massive jump in
progress!
